---
# Allow builds to run for up to 30 minutes.
timeout: 1800s

steps:

# Build 7.3 images.

  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    id: 73-pull
    waitFor: ['-']
    args: ['-c', 'docker pull $_DOCKER_HUB_REPO/php:7.3-fpm || exit 0']

  - name: 'gcr.io/cloud-builders/docker'
    waitFor: [73-pull]
    id: 73-build
    args: ['build', '-t', 'build/php:7.3', '--cache-from', '$_DOCKER_HUB_REPO/php:7.3-fpm', '--build-arg', 'SRC_TAG=7.3.3-fpm-alpine3.9', '.']

  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    waitFor: [73-pull]
    id: 73-composer-pull
    args: ['-c', 'docker pull $_DOCKER_HUB_REPO/php:7.3-fpm-composer || exit 0']

  - name: 'gcr.io/cloud-builders/docker'
    waitFor: [73-composer-pull, 73-build]
    id: 73-composer-build
    args: ['build', '-t', 'build/php:7.3-composer', '--cache-from', '$_DOCKER_HUB_REPO/php:7.3-fpm-composer', '--build-arg', 'PHP_VERSION=7.3', '-f', 'Dockerfile-composer', '.']


# Build 7.2 images.

  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    id: 72-pull
    waitFor: ['-']
    args: ['-c', 'docker pull $_DOCKER_HUB_REPO/php:7.2-fpm || exit 0']

  - name: 'gcr.io/cloud-builders/docker'
    waitFor: [72-pull]
    id: 72-build
    args: ['build', '-t', 'build/php:7.2', '--cache-from', '$_DOCKER_HUB_REPO/php:7.2-fpm', '--build-arg', 'SRC_TAG=7.2.19-fpm-alpine3.9', '.']

  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    waitFor: [72-pull]
    id: 72-composer-pull
    args: ['-c', 'docker pull $_DOCKER_HUB_REPO/php:7.2-fpm-composer || exit 0']

  - name: 'gcr.io/cloud-builders/docker'
    waitFor: [72-composer-pull, 72-build]
    id: 72-composer-build
    args: ['build', '-t', 'build/php:7.2-composer', '--cache-from', '$_DOCKER_HUB_REPO/php:7.2-fpm-composer', '--build-arg', 'PHP_VERSION=7.2', '-f', 'Dockerfile-composer', '.']


# Tag images.

  - name: 'gcr.io/cloud-builders/docker'
    waitFor: [72-build]
    id: 72-tag-fpm
    args: ['tag', 'build/php:7.2', '$_DOCKER_HUB_REPO/php:7.2-fpm']

  - name: 'gcr.io/cloud-builders/docker'
    waitFor: [72-composer-build]
    id: 72-composer-tag
    args: ['tag', 'build/php:7.2-composer', '$_DOCKER_HUB_REPO/php:7.2-composer']

  - name: 'gcr.io/cloud-builders/docker'  # Backwards compatibility.
    waitFor: [72-composer-build]
    id: 72-composer-tag-fpm
    args: ['tag', 'build/php:7.2-composer', '$_DOCKER_HUB_REPO/php:7.2-fpm-composer']

  - name: 'gcr.io/cloud-builders/docker'
    waitFor: [73-build]
    id: 73-tag-fpm
    args: ['tag', 'build/php:7.3', '$_DOCKER_HUB_REPO/php:7.3-fpm']

  - name: 'gcr.io/cloud-builders/docker'
    waitFor: [73-composer-build]
    id: 73-composer-tag
    args: ['tag', 'build/php:7.3-composer', '$_DOCKER_HUB_REPO/php:7.3-composer']

  - name: 'gcr.io/cloud-builders/docker'  # Backwards compatibility.
    waitFor: [73-composer-build]
    id: 73-composer-tag-fpm
    args: ['tag', 'build/php:7.3-composer', '$_DOCKER_HUB_REPO/php:7.3-fpm-composer']

# Login and push images.
  - name: 'gcr.io/cloud-builders/gcloud'
    id: decrypt-hub-username
    args:
      - 'kms'
      - 'decrypt'
      - '--location=global'
      - '--keyring=docker'
      - '--key=hub'
      - '--ciphertext-file=.cloudbuild/docker-hub-username.enc'
      - '--plaintext-file=docker-hub-username.txt'

  - name: 'gcr.io/cloud-builders/gcloud'
    id: decrypt-hub-password
    args:
      - 'kms'
      - 'decrypt'
      - '--location=global'
      - '--keyring=docker'
      - '--key=hub'
      - '--ciphertext-file=.cloudbuild/docker-hub-password.enc'
      - '--plaintext-file=docker-hub-password.txt'

  - name: 'gcr.io/cloud-builders/docker'
    waitFor:
      - 72-tag-fpm
      - 72-composer-tag
      - 72-composer-tag-fpm
      - 73-tag-fpm
      - 73-composer-tag
      - 73-composer-tag-fpm
      - decrypt-hub-username
      - decrypt-hub-password
    entrypoint: 'bash'
    args: ['-c', 'cat docker-hub-password.txt | docker login --username=$$(cat docker-hub-username.txt) --password-stdin']

images:
  - '$_DOCKER_HUB_REPO/php'
